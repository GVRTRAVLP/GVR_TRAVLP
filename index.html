// app.js
require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const Razorpay = require('razorpay');
const crypto = require('crypto');
const nodemailer = require('nodemailer');
const cors = require('cors');
const axios = require('axios');

const app = express();
app.use(bodyParser.json());
app.use(cors());

// Load env
const {
  RAZORPAY_KEY_ID,
  RAZORPAY_KEY_SECRET,
  RAZORPAY_WEBHOOK_SECRET,
  ADMIN_EMAIL,
  ADMIN_PHONE,
  SMTP_HOST,
  SMTP_PORT,
  SMTP_USER,
  SMTP_PASS,
  TWILIO_SID,
  TWILIO_AUTH_TOKEN,
  TWILIO_WHATSAPP_FROM, // e.g., 'whatsapp:+1415xxxxxxx'
  PORT = 3000
} = process.env;

const razorpay = new Razorpay({
  key_id: RAZORPAY_KEY_ID,
  key_secret: RAZORPAY_KEY_SECRET
});

// Setup nodemailer
const transporter = nodemailer.createTransport({
  host: SMTP_HOST,
  port: Number(SMTP_PORT || 587),
  secure: SMTP_PORT==465, // true for 465, false for other
  auth: {
    user: SMTP_USER,
    pass: SMTP_PASS
  }
});

// Twilio init (optional - for WhatsApp)
let twilioClient = null;
if(TWILIO_SID && TWILIO_AUTH_TOKEN){
  const twilio = require('twilio');
  twilioClient = twilio(TWILIO_SID, TWILIO_AUTH_TOKEN);
}

// Helper to send email to admin + customer
async function sendEmails(booking){
  const subject = `New Booking — ${booking.trip} — ${booking.bookingId}`;
  const text = `
Booking ID: ${booking.bookingId}
Trip: ${booking.trip}
Date: ${booking.date}
Price: ₹${booking.price}
Name: ${booking.name}
Mobile: ${booking.mobile}
Email: ${booking.email || 'N/A'}
Payment ID: ${booking.paymentId}
  `;
  // To admin
  await transporter.sendMail({
    from: SMTP_USER,
    to: ADMIN_EMAIL,
    subject,
    text
  }).catch(err => console.error('email admin error', err));

  // To customer if email exists
  if(booking.email){
    await transporter.sendMail({
      from: SMTP_USER,
      to: booking.email,
      subject: `Your booking is confirmed — ${booking.trip}`,
      text: `Thank you ${booking.name}!\n\nYour booking is confirmed.\n\n${text}`
    }).catch(err => console.error('email customer error', err));
  }
}

// Helper to send whatsapp via Twilio (optional)
async function sendWhatsApp(booking){
  if(!twilioClient) return;
  const to = 'whatsapp:+91' + booking.mobile; // assumes Indian number
  const body = `Thank you ${booking.name}! Your booking is confirmed.\n\nBooking ID: ${booking.bookingId}\nTrip: ${booking.trip}\nDate: ${booking.date}\nPrice: ₹${booking.price}\nPayment ID: ${booking.paymentId}\nOrganizer: ${ADMIN_PHONE}`;

  try{
    await twilioClient.messages.create({
      from: TWILIO_WHATSAPP_FROM, // e.g. 'whatsapp:+1415xxx'
      to,
      body
    });
  }catch(err){
    console.error('whatsapp send error', err);
  }
}

// 1) Create order endpoint - called by front-end
app.post('/create-order', async (req, res) => {
  try{
    const { amount, currency='INR', customer, trip } = req.body;
    if(!amount || !customer || !customer.mobile) return res.status(400).json({ message: 'Missing fields' });

    // create order in Razorpay (amount in paise)
    const order = await razorpay.orders.create({
      amount: Math.round(amount * 100), // rupees to paise
      currency,
      receipt: `receipt_${Date.now()}`,
      payment_capture: 1, // auto capture
      notes: {
        customer_name: customer.name || '',
        customer_mobile: customer.mobile,
        trip_title: trip.title || '',
        trip_date: trip.date || ''
      }
    });

    res.json({
      key: RAZORPAY_KEY_ID,
      order
    });
  }catch(err){
    console.error(err);
    res.status(500).json({ message: 'Order creation failed', error: err.message });
  }
});

// 2) Verify payment endpoint - called by frontend after checkout success
app.post('/verify-payment', async (req, res) => {
  try{
    const { razorpay_payment_id, razorpay_order_id, razorpay_signature, customer, trip } = req.body;
    // verify signature
    const hmac = crypto.createHmac('sha256', RAZORPAY_KEY_SECRET);
    hmac.update(razorpay_order_id + "|" + razorpay_payment_id);
    const generated_signature = hmac.digest('hex');

    if(generated_signature !== razorpay_signature){
      return res.status(400).json({ message: 'Invalid signature' });
    }

    // At this point payment is valid. Create booking record (in real app save to DB)
    const booking = {
      bookingId: 'GVRBOOK' + Date.now(),
      paymentId: razorpay_payment_id,
      orderId: razorpay_order_id,
      trip: trip.title,
      date: trip.date,
      price: trip.price,
      name: customer.name,
      mobile: customer.mobile,
      email: customer.email,
      age: customer.age,
      gender: customer.gender,
      notes: customer.notes
    };

    // Send emails and whatsapp notifications
    sendEmails(booking).catch(console.error);
    sendWhatsApp(booking).catch(console.error);

    // Optionally send organizer WhatsApp/email separately (already sent to ADMIN_EMAIL)
    // Return booking to frontend
    res.json({ success: true, booking });
  }catch(err){
    console.error(err);
    res.status(500).json({ message: 'Verification error', error: err.message });
  }
});

// 3) Razorpay webhook endpoint (recommended) — verify webhook signature and process events like payment.captured
app.post('/webhook', bodyParser.raw({ type: '*/*' }), (req, res) => {
  const signature = req.headers['x-razorpay-signature'];
  const payload = req.body; // raw buffer
  const expected = crypto.createHmac('sha256', RAZORPAY_WEBHOOK_SECRET).update(payload).digest('hex');

  if(signature === expected){
    const event = JSON.parse(payload.toString());
    // handle event e.g., payment.captured, payment.failed
    console.log('webhook event', event.event);

    // OPTIONAL: for payment.captured, you may re-check and send notifications if not already sent

    res.json({ ok: true });
  }else{
    res.status(400).send('Invalid signature');
  }
});

app.listen(PORT, ()=>console.log(`Server listening on ${PORT}`));
