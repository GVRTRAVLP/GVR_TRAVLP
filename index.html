<script async src="//www.instagram.com/embed.js"></script>
<script>
const ADMIN_EMAIL = "gangavenkataramana@gmail.com";
const ADMIN_PHONE = "+919390184813";
const UPI_ID = "27722222@ybl";
const PAY_LINK = ""; // optional deep link
const tripsData = {
  "üü¶ TREKKING / NATURE": [
    {"title":"Ananthagiri Hills","price":993,"img":"assets/places/1.jpg"},
    {"title":"Bhongir Fort","price":905,"img":"assets/places/2.jpg"},
    {"title":"Koil Sagar + Koilkonda","price":1250,"img":"assets/places/3.jpg"},
    {"title":"Pocharam + Nizam Sagar","price":1122,"img":"assets/places/4.jpg"},
    {"title":"Bogatha Waterfalls","price":1525,"img":"assets/places/5.jpg"}
  ],
  "üü¶ DEVOTIONAL": [
    {"title":"Yadadri","price":930,"img":"assets/places/6.jpg"},
    {"title":"Vemulawada","price":1250,"img":"assets/places/7.jpg"},
    {"title":"Basara","price":1460,"img":"assets/places/8.jpg"},
    {"title":"Kondagattu","price":1393,"img":"assets/places/9.jpg"},
    {"title":"Bhadrachalam","price":1800,"img":"assets/places/10.jpg"}
  ],
  "üü¶ WATERFALLS / NATURE": [
    {"title":"Papikondalu","price":1765,"img":"assets/places/11.jpg"},
    {"title":"Laknavaram","price":1460,"img":"assets/places/12.jpg"},
    {"title":"Ramappa Temple + Lake","price":1495,"img":"assets/places/1.jpg"},
    {"title":"Kuntala + Pochera","price":1720,"img":"assets/places/2.jpg"},
    {"title":"Gayatri Waterfalls","price":1645,"img":"assets/places/3.jpg"}
  ],
  "üü¶ ANDHRA PRADESH TRIPS": [
    {"title":"Srisailam","price":1525,"img":"assets/places/4.jpg"},
    {"title":"Horsley Hills","price":2670,"img":"assets/places/5.jpg"},
    {"title":"Gandikota","price":2065,"img":"assets/places/6.jpg"},
    {"title":"Ahobilam","price":1995,"img":"assets/places/7.jpg"}
  ],
  "üü¶ KARNATAKA TRIPS": [
    {"title":"Bidar","price":1215,"img":"assets/places/8.jpg"},
    {"title":"Basavakalyan Fort","price":1460,"img":"assets/places/9.jpg"},
    {"title":"Hampi","price":2065,"img":"assets/places/10.jpg"}
  ],
  "üü¶ MAHARASHTRA TRIPS": [
    {"title":"Nanded (Hazur Sahib)","price":1720,"img":"assets/places/11.jpg"},
    {"title":"Ajanta & Ellora","price":2600,"img":"assets/places/12.jpg"}
  ],
  "üü® ANDHRA PRADESH EXTRA PLACES": [
    {"title":"Araku Valley","price":2890,"img":"assets/places/1.jpg"},
    {"title":"Katiki Waterfalls","price":2960,"img":"assets/places/2.jpg"},
    {"title":"Borra Caves","price":2960,"img":"assets/places/3.jpg"}
  ],
  "‚≠ê COMBO TRIPS":[
    {"title":"Combo 1: Bhadrachalam + Papikondalu","price":1900,"img":"assets/places/4.jpg"},
    {"title":"Combo 2: Laknavaram + Ramappa Temple","price":1600,"img":"assets/places/5.jpg"},
    {"title":"Combo 3: Ananthagiri Hills + Kotepally","price":1150,"img":"assets/places/6.jpg"},
    {"title":"Combo 4: Srisailam Full Trip","price":1650,"img":"assets/places/7.jpg"},
    {"title":"Combo 5: Gandikota + Belum Caves","price":2250,"img":"assets/places/8.jpg"},
    {"title":"Combo 6: Kuntala + Pochera + Basara","price":1950,"img":"assets/places/9.jpg"},
    {"title":"Combo 7: Hampi","price":2200,"img":"assets/places/10.jpg"},
    {"title":"Combo 8: Ahobilam Trek","price":2150,"img":"assets/places/11.jpg"}
  ]
};

let passengerDetails = {}; // Global variable to store details

// Render trip groups
function renderTrips(){
  const container = document.getElementById('tripList');
  for(const [group, arr] of Object.entries(tripsData)){
    const section = document.createElement('div');
    section.innerHTML = `<div class="groupTitle">${group}</div>`;
    const grid = document.createElement('div'); grid.className = 'grid';
    arr.forEach(item=>{
      const card = document.createElement('div');
      card.className = 'tripCard';
      card.innerHTML = `<div><img src="${item.img}" alt="${item.title}"></div>
        <div class="tripInfo"><strong>${item.title}</strong><div class="price">‚Çπ${item.price}</div></div>
        <div><button onclick="selectTrip('${item.title.replace(/'/g,'\'')}',${item.price})">Book ‚Çπ${item.price}</button></div>`;
      grid.appendChild(card);
    });
    section.appendChild(grid);
    container.appendChild(section);
  }
}

// populate selectTrip dropdown
function populateSelect(){
  const sel = document.getElementById('selectTrip');
  sel.innerHTML = '';
  for(const arr of Object.values(tripsData)){
    for(const t of arr){
      const opt = document.createElement('option');
      opt.value = `${t.title}||${t.price}`;
      opt.text = `${t.title} ‚Äî ‚Çπ${t.price}`;
      sel.appendChild(opt);
    }
  }
}

// weekend dates generator
function generateWeekends(fromDate, endDate){
  const arr=[];
  const d = new Date(fromDate);
  while(d<=endDate){
    if(d.getDay()===0 || d.getDay()===6){
      arr.push(new Date(d));
    }
    d.setDate(d.getDate()+1);
  }
  return arr;
}
function populateDates(){
  const sel = document.getElementById('selectDate');
  const today = new Date();
  const end = new Date('2026-12-31');
  const weekends = generateWeekends(today, end);
  weekends.forEach(dt=>{
    const o = document.createElement('option');
    o.value = dt.toISOString();
    o.text = dt.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
    sel.appendChild(o);
  });
}

// flow helpers
function selectTrip(title, price){
  // set select options and go to details
  const sel = document.getElementById('selectTrip');
  for(let i=0;i<sel.options.length;i++){
    if(sel.options[i].value.startsWith(title + '||')){ sel.selectedIndex = i; break; }
  }
  goToDetails();
}
function goToDetails(){
  document.getElementById('step1').classList.add('hidden');
  document.getElementById('step2').classList.remove('hidden');
  document.getElementById('step1Label').classList.remove('active');
  document.getElementById('step2Label').classList.add('active');
}
function backToSelect(){
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step1').classList.remove('hidden');
  document.getElementById('step2Label').classList.remove('active');
  document.getElementById('step1Label').classList.add('active');
}
function goToPay(){
  // validate and save details
  const name = document.getElementById('p_name').value.trim();
  const mobile = document.getElementById('p_mobile').value.trim();
  const age = document.getElementById('p_age').value.trim();
  const gender = document.getElementById('p_gender').value.trim();
  const email = document.getElementById('p_email').value.trim();
  const notes = document.getElementById('p_notes').value.trim();

  if(!name || !mobile.match(/^\d{10}$/) || !age || !gender){ 
      alert('Please enter valid Name, 10-digit Mobile, Age, and select Gender.'); 
      return; 
  }

  // Save details to global variable
  passengerDetails = { name, mobile, age, gender, email, notes };

  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.remove('hidden');
  document.getElementById('step2Label').classList.remove('active');
  document.getElementById('step3Label').classList.add('active');
  
  // show amount
  const sel = document.getElementById('selectTrip').value;
  const price = sel.split('||')[1];
  document.getElementById('payAmount').textContent = '‚Çπ' + price;
}
function backToDetails(){
  document.getElementById('step3').classList.add('hidden');
  document.getElementById('step2').classList.remove('hidden');
  document.getElementById('step3Label').classList.remove('active');
  document.getElementById('step2Label').classList.add('active');
}
function copyUPI(){
  navigator.clipboard && navigator.clipboard.writeText(UPI_ID).then(()=>alert('UPI copied: '+UPI_ID), ()=>{ alert('Copy manually: '+UPI_ID) });
}
function openUpi(){
  const sel = document.getElementById('selectTrip').value;
  const [title, price] = sel.split('||');
  const uri = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent('GVR_TRAVLP')}&mc=0000&tid=${new Date().getTime()}&tr=Ref${new Date().getTime()}&tn=${encodeURIComponent('Trip payment for ' + title)}&am=${price}&cu=INR`;
  
  // Try to open UPI app first
  window.location.href = uri;
  
  // Alert for manual payment if deep link fails
  setTimeout(() => {
     alert('If the UPI app did not open, please pay manually by scanning the QR or using the UPI ID.');
  }, 1000);
}

function confirmPaid(){
  const sel = document.getElementById('selectTrip').value;
  const [title, price] = sel.split('||');
  const date = new Date(document.getElementById('selectDate').value).toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
  const txn = document.getElementById('txn_ref').value.trim();

  // Construct final payload
  const payload = {
    trip: title,
    price: price,
    date: date,
    name: passengerDetails.name, 
    mobile: passengerDetails.mobile, 
    age: passengerDetails.age, 
    gender: passengerDetails.gender, 
    email: passengerDetails.email, 
    notes: passengerDetails.notes, 
    txn: txn || 'Not Provided',
    submittedAt: new Date().toISOString()
  };

  const bookingSummary = `
Trip: ${payload.trip}
Date: ${payload.date}
Price: ‚Çπ${payload.price}
---
Name: ${payload.name}
Mobile: ${payload.mobile}
Age/Gender: ${payload.age}/${payload.gender}
Email: ${payload.email || 'N/A'}
Notes: ${payload.notes || 'N/A'}
---
Payment Txn Ref: ${payload.txn}
  `;

  // Provide the user with the details to manually send
  const whatsappUrl = 'https://wa.me/' + ADMIN_PHONE.replace(/\D/g,'') + '?text=' + encodeURIComponent('New Registration & Payment Confirmation:\n\n' + bookingSummary);

  // Show confirmation step
  document.getElementById('step3').classList.add('hidden');
  document.getElementById('step4').classList.remove('hidden');
  document.getElementById('step3Label').classList.remove('active');
  document.getElementById('step4Label').classList.add('active');

  document.getElementById('confMsg').innerHTML = `
    Thank you ${payload.name}. Your registration is complete!
    <br><br>
    <strong>Please share your booking details with the organizer immediately to confirm your seat:</strong>
    <br>
    <textarea rows="8" style="width:100%; margin-top: 8px;" id="bookingDetails">${bookingSummary.trim()}</textarea>
    <button style="margin-top: 8px;" onclick="copyBookingDetails()">Copy Details</button>
    <a href="${whatsappUrl}" target="_blank" style="display: block; margin-top: 10px;">
        <button style="background-color: #25d366;">Send on WhatsApp</button>
    </a>
  `;
}
function copyBookingDetails(){
    const details = document.getElementById('bookingDetails');
    details.select();
    details.setSelectionRange(0, 99999); 
    navigator.clipboard.writeText(details.value);
    alert('Booking details copied to clipboard!');
}

function finish(){ alert('Thanks! Organizer will contact you soon.'); startOver(); }
function startOver(){
  // reset to step1 and clear inputs
  document.getElementById('step4').classList.add('hidden');
  document.getElementById('step1').classList.remove('hidden');
  document.getElementById('step4Label').classList.remove('active');
  document.getElementById('step1Label').classList.add('active');
  document.getElementById('p_name').value=''; document.getElementById('p_mobile').value=''; document.getElementById('p_age').value='';
  document.getElementById('p_gender').value=''; document.getElementById('p_email').value=''; document.getElementById('p_notes').value='';
  document.getElementById('txn_ref').value='';
  passengerDetails = {}; // Clear stored data
}

document.addEventListener('DOMContentLoaded', function(){
  renderTrips();
  populateSelect();
  populateDates();
});
</script>
