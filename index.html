<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GVR_TRAVLP ‚Äî Weekend Trips (gvrtra)</title>
  <meta name="description" content="GVR_TRAVLP ‚Äî Weekend trips from Hyderabad. Book trekking, devotional, waterfalls and combo trips. Search gvrtra to find us." />
  <meta name="author" content="Ram (GVR)" />
  <style>
    :root{
      --accent:#ff7a18; --muted:#666; --bg:#fbf7f0; --card:#fff;
      --maxW:1100px; --radius:12px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, Arial, sans-serif; margin:0; color:#222; background:var(--bg)}
    .wrap{max-width:var(--maxW); margin:20px auto; padding:18px}
    header{display:flex; gap:14px; align-items:center}
    .logo{width:86px; height:86px; border-radius:14px; object-fit:contain; background:#fff; padding:8px}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:14px}
    .hero{display:grid; grid-template-columns:1fr 380px; gap:18px; margin-top:18px}
    .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    .media{border-radius:10px; overflow:hidden; height:300px; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#eef2f6,#fff)}
    .gallery{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
    .gallery .thumb{width:120px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer; border:2px solid transparent}
    .gallery .thumb.active{border-color:var(--accent)}
    .trips{margin-top:14px}
    .groupTitle{font-weight:700; margin:10px 0 8px; font-size:16px}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px}
    .tripCard{background:linear-gradient(#fff,#fff); border-radius:10px; padding:12px; min-height:120px; display:flex; flex-direction:column; justify-content:space-between}
    .tripCard h4{margin:6px 0 0;font-size:16px}
    .price{color:var(--accent); font-weight:700; margin-top:8px; font-size:18px}
    aside .card{position:sticky; top:18px}
    form{display:flex; flex-direction:column; gap:8px}
    input, select, button, textarea{padding:10px; border-radius:8px; border:1px solid #eaeaea; font-size:14px}
    button{background:var(--accent); color:#fff; border:none; cursor:pointer}
    .muted{color:var(--muted); font-size:13px}
    .payBox{display:flex; gap:10px; align-items:center}
    .qr{width:130px; height:130px; object-fit:contain; border-radius:8px; background:#fff; padding:6px; box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .small{font-size:13px}
    .actions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
    .ghost{background:#fff;color:var(--accent);border:1px solid #eee}
    footer{margin-top:22px; color:var(--muted); text-align:center; padding-bottom:40px}
    .flex{display:flex; gap:10px; align-items:center}
    .uploader{border:2px dashed #e9e9e9; padding:8px; border-radius:8px; background: #fff; cursor:pointer; display:inline-block}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:2000}
    .modal .card{width:420px; max-width:94%; padding:18px}
    .modal.open{display:flex}
    .trip-actions{display:flex; gap:8px; margin-top:10px}
    .pill{padding:6px 10px;border-radius:999px;background:#f7f7f7;border:1px solid #eee;font-size:13px}
    @media(max-width:900px){
      .hero{grid-template-columns:1fr}
      .media{height:240px}
      .qr{width:100px;height:100px}
    }
    /* simple responsive table for copyable list */
    .list-table{width:100%; border-collapse:collapse}
    .list-table td{padding:8px; border-bottom:1px dashed #eee; vertical-align:middle}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="" alt="GVR_TRAVLP" class="logo" id="siteLogo">
      <div>
        <h1>GVR_TRAVLP ‚Äî Weekend Traveller</h1>
        <div class="sub">Follow @gvryalla ¬∑ Search "gvrtra" to find us ¬∑ Hyderabad trips & weekend adventures</div>
      </div>
    </header>

    <section class="hero">
      <!-- LEFT: media + trips -->
      <div>
        <div class="card">
          <div class="media" id="mainMedia">
            <div style="text-align:center; color:var(--muted)">
              <div style="font-weight:700; margin-bottom:8px">Place previews</div>
              <div class="muted">Upload Images.pdf (or click thumbnails below) to populate gallery</div>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center">
            <div style="display:flex; gap:8px; align-items:center">
              <label class="uploader" id="pdfUploaderLabel">
                Upload Images PDF
                <input type="file" id="pdfUploader" accept="application/pdf" style="display:none">
              </label>
              <label class="uploader" id="logoUploaderLabel">
                Upload Logo (PNG/JPG)
                <input type="file" id="logoUploader" accept="image/*" style="display:none">
              </label>
              <label class="uploader" id="qrUploaderLabel">
                Upload QR (PNG/JPG)
                <input type="file" id="qrUploader" accept="image/*" style="display:none">
              </label>
            </div>

            <div class="muted small">Tip: PDF + logo + qr will be saved in browser session (local only)</div>
          </div>

          <div class="gallery" id="placesGallery" style="margin-top:10px"></div>
        </div>

        <div class="trips">
          <div class="card" style="margin-top:12px">
            <div class="groupTitle">üü¶ TREKKING / NATURE</div>
            <div class="grid" id="trekkingGrid"></div>

            <div class="groupTitle" style="margin-top:14px">üü¶ DEVOTIONAL</div>
            <div class="grid" id="devotionalGrid"></div>

            <div class="groupTitle" style="margin-top:14px">üü¶ WATERFALLS / NATURE</div>
            <div class="grid" id="waterfallsGrid"></div>

            <div class="groupTitle" style="margin-top:14px">‚≠ê COMBO TRIPS</div>
            <div class="grid" id="comboGrid"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: registration & payment -->
      <aside>
        <div class="card">
          <h3>Register & Pay</h3>
          <p class="muted">Select trip, date and click Pay. We'll open your UPI app (mobile) or show QR for scanning.</p>

          <label class="small">Select Trip</label>
          <select id="tripSelect"></select>

          <label class="small">Select Weekend Date</label>
          <select id="dateSelect"></select>

          <div style="margin-top:10px" class="card">
            <div class="payBox" style="align-items:flex-start">
              <img src="" alt="QR" class="qr" id="qrImg" onerror="this.style.display='none'">
              <div style="flex:1">
                <div style="font-weight:700">UPI ID</div>
                <div style="font-size:18px; color:var(--accent); font-weight:700" id="upiText">27722222@ybl</div>
                <div class="small muted">Tap to copy or use "Open UPI app" below</div>

                <div class="actions">
                  <button type="button" onclick="copyUPI()" class="ghost">Copy UPI ID</button>
                  <button type="button" onclick="openPayLink()" class="ghost">Open UPI App</button>
                </div>
              </div>
            </div>

            <div style="margin-top:10px" class="muted small">
              After you pay, click <strong>I have paid</strong> and submit the registration (we will open mail & whatsapp for organizer notification).
            </div>

            <div class="actions" style="margin-top:10px">
              <button id="paidBtn" type="button" onclick="onPaidClicked()">I have paid</button>
              <button type="button" class="ghost" onclick="showInstructions()">Payment help</button>
            </div>
          </div>

          <form id="registerForm" style="display:none; margin-top:12px">
            <label class="small">Full name</label>
            <input type="text" id="name" required placeholder="Your name">

            <label class="small">Mobile (10 digits)</label>
            <input type="tel" id="mobile" placeholder="9390xxxxxxx" pattern="[0-9]{10}" required>

            <label class="small">Transaction ID (optional)</label>
            <input type="text" id="txn" placeholder="UPI transaction id / reference">

            <label class="small">Notes (optional)</label>
            <textarea id="notes" rows="2" placeholder="Any notes (e.g. pickup point)"></textarea>

            <button type="submit">Confirm & Notify (Send)</button>

            <p id="formMsg" class="muted small" style="margin-top:8px"></p>
          </form>

          <hr style="margin-top:12px">

          <p class="muted small">Contact organizer directly:</p>
          <p style="margin:6px 0"><a id="waLink" href="#" target="_blank">Message on WhatsApp</a></p>
          <p style="margin:6px 0"><a id="smsLink" href="#" target="_blank">Send SMS</a></p>

          <div style="margin-top:8px" class="muted small">Email: <a href="mailto:gangavenkataramana@gmail.com">gangavenkataramana@gmail.com</a></div>
        </div>
      </aside>
    </section>

    <footer class="muted">¬© GVR_TRAVLP ‚Äî Travel far and feed with love ¬∑ Follow @gvryalla</footer>
  </div>

  <!-- pdf.js from CDN -->
  <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

  <script>
    /********* CONFIG *********/
    const ADMIN_EMAIL = 'gangavenkataramana@gmail.com';
    const ADMIN_PHONE = '+919390184813'; // whatsapp +91 9390184813
    const UPI_ID = '27722222@ybl';      // <<-- provided UPI ID
    const DEFAULT_WA_MESSAGE = 'Hi GVR, I want to know about upcoming trips.';
    const SITE_SEARCH_KEYWORDS = ['gvrtra','GVR_TRAVLP','gvryalla'];

    /********* TRIPS DATA *********/
    const trips = {
      trekking: [
        {title: 'Ananthagiri Hills', price: '‚Çπ993'},
        {title: 'Bhongir Fort', price: '‚Çπ905'},
        {title: 'Koil Sagar + Koilkonda', price: '‚Çπ1,250'},
        {title: 'Pocharam + Nizam Sagar', price: '‚Çπ1,122'},
        {title: 'Bogatha Waterfalls', price: '‚Çπ1,525'}
      ],
      devotional: [
        {title: 'Yadadri', price: '‚Çπ930'},
        {title: 'Vemulawada', price: '‚Çπ1,250'},
        {title: 'Basara', price: '‚Çπ1,460'},
        {title: 'Kondagattu', price: '‚Çπ1,393'},
        {title: 'Bhadrachalam', price: '‚Çπ1,800'}
      ],
      waterfalls: [
        {title: 'Papikondalu', price: '‚Çπ1,765'},
        {title: 'Laknavaram', price: '‚Çπ1,460'},
        {title: 'Ramappa Temple + Lake', price: '‚Çπ1,495'},
        {title: 'Kuntala + Pochera', price: '‚Çπ1,720'},
        {title: 'Gayatri Waterfalls', price: '‚Çπ1,645'}
      ],
      combo: [
        {title: 'Bhadrachalam + Papikondalu', price: '‚Çπ1,900'},
        {title: 'Laknavaram + Ramappa Temple', price: '‚Çπ1,600'},
        {title: 'Ananthagiri Hills + Kotepally', price: '‚Çπ1,150'},
        {title: 'Srisailam Full Trip', price: '‚Çπ1,650'}
      ]
    };

    /********* SIMPLE HELPERS *********/
    function el(id){ return document.getElementById(id); }
    function q(sel, root=document){ return root.querySelector(sel); }

    /********* Load defaults (logo + QR) from uploaded dev container or fallback blank */ 
    const siteLogoEl = el('siteLogo');
    const qrImgEl = el('qrImg');
    // If you have uploaded logo/qr files to the same folder on hosting, set relative paths here.
    // If you want to use the uploaded files you provided via the chat (Images.pdf, qr.png), you can
    // replace these src with 'assets/logo.png'/'assets/qr.png' after uploading to your hosting.
    // For local preview, we'll try to read from browser localStorage (set later when user uploads).
    function restoreSavedImages(){
      const logoData = localStorage.getItem('gvr_logo');
      const qrData = localStorage.getItem('gvr_qr');
      if(logoData){ siteLogoEl.src = logoData; } else { siteLogoEl.src = ''; siteLogoEl.style.background='linear-gradient(45deg,#fff,#f6f6f6)'; siteLogoEl.alt='GVR_TRAVLP'; }
      if(qrData){ qrImgEl.src = qrData; qrImgEl.style.display='block'; } else { qrImgEl.src=''; qrImgEl.style.display='none'; }
    }
    restoreSavedImages();

    /********* Render trips UI *********/
    function createTripCard(t){
      const div = document.createElement('div'); div.className='tripCard';
      div.innerHTML = `
        <div>
          <h4>${escapeHtml(t.title)}</h4>
          <div class="price">${escapeHtml(t.price)}</div>
        </div>
        <div>
          <div class="trip-actions">
            <button class="ghost" type="button" onclick="viewPlace('${escapeJs(t.title)}')">View</button>
            <button type="button" onclick="startPay('${escapeJs(t.title)}','${escapeJs(t.price)}')">Pay & Book</button>
          </div>
        </div>
      `;
      return div;
    }
    function renderAllTrips(){
      ['trekking','devotional','waterfalls','combo'].forEach(k=>{
        const id = k+'Grid';
        const cont = el(id);
        if(!cont) return;
        cont.innerHTML='';
        trips[k].forEach(t => cont.appendChild(createTripCard(t)));
      });
      // populate select
      const tripSelect = el('tripSelect');
      tripSelect.innerHTML = '';
      Object.values(trips).flat().forEach(t => {
        const o = document.createElement('option'); o.value = `${t.title} ‚Äî ${t.price}`; o.textContent = `${t.title} ‚Äî ${t.price}`;
        tripSelect.appendChild(o);
      });
    }
    renderAllTrips();

    /********* Date generation for weekends (Sat & Sun) *********/
    function generateWeekendDates(start, end){
      const arr = [];
      const d = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      while(d <= end){
        const day = d.getDay();
        if(day === 0 || day === 6){
          arr.push(new Date(d.getTime()));
        }
        d.setDate(d.getDate() + 1);
      }
      return arr;
    }
    const today = new Date();
    const endDate = new Date('2026-12-31T23:59:59');
    const weekends = generateWeekendDates(today, endDate);
    const dateSelect = el('dateSelect');
    weekends.forEach(dt=>{
      const opt = document.createElement('option');
      const dd = dt.toLocaleDateString(undefined, {weekday:'short', day:'2-digit', month:'short', year:'numeric'});
      opt.value = dt.toISOString(); opt.textContent = dd;
      dateSelect.appendChild(opt);
    });

    /********* UPI / Payment functions *********/
    function copyUPI(){
      if(navigator.clipboard){
        navigator.clipboard.writeText(UPI_ID).then(()=> alert('UPI ID copied: ' + UPI_ID), ()=> fallbackCopy(UPI_ID));
      } else fallbackCopy(UPI_ID);
    }
    function fallbackCopy(text){
      const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); alert('UPI ID copied: ' + text); }catch(e){ alert('Copy failed ‚Äî please copy manually: ' + text); }
      ta.remove();
    }
    function openPayLink(customAmount){
      // Try to open UPI deep link for mobile; if desktop, open QR image in new tab for scanning
      const amountParam = customAmount ? `&am=${encodeURIComponent(customAmount)}` : '';
      const upiUri = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent('GVR_TRAVLP')}&tn=${encodeURIComponent('Trip payment')}${amountParam}`;
      // try to open
      window.location.href = upiUri;
      // and also open the QR image in a new tab
      const qr = localStorage.getItem('gvr_qr') || qrImgEl.src || '';
      if(qr) window.open(qr, '_blank');
    }

    function showInstructions(){
      alert('Use any UPI app to scan the QR or copy the UPI ID. After payment click "I have paid" and complete registration.');
    }

    /********* Booking UI + Modal behavior *********/
    const modal = document.createElement('div'); modal.className='modal'; modal.innerHTML = `
      <div class="card">
        <h3 id="modalTitle">Pay & Book</h3>
        <div id="modalBody"></div>
        <div style="margin-top:12px; text-align:right">
          <button class="ghost" id="modalClose">Close</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    el('modalClose') && el('modalClose').addEventListener('click', closeModal); // in case element exists early

    function openModal(title, innerHtml){
      modal.classList.add('open');
      q('#modalTitle', modal).textContent = title;
      q('#modalBody', modal).innerHTML = innerHtml;
      // bind close
      q('#modalClose', modal).onclick = closeModal;
      // bind copy upi inside modal if present
      const copyBtn = q('#modalBody .copy-upi', modal);
      if(copyBtn) copyBtn.onclick = copyUPI;
      const openBtn = q('#modalBody .open-upi', modal);
      if(openBtn) openBtn.onclick = () => openPayLink();
      // if pay-with-amount button present
      const payAmtBtn = q('#modalBody .pay-amount');
      if(payAmtBtn) payAmtBtn.onclick = () => {
        const amt = q('#modalBody input[name="amount"]').value || '';
        openPayLink(amt);
      };
    }
    function closeModal(){ modal.classList.remove('open'); }

    function startPay(title, price){
      const numeric = price.replace(/[^\d.]/g,'');
      const inner = `
        <div style="display:flex; gap:12px; align-items:center">
          <img src="${qrImgEl.src || ''}" class="qr" alt="QR" onerror="this.style.display='none'">
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(title)}</div>
            <div style="margin-top:6px">Amount: <span style="color:var(--accent); font-weight:700">${escapeHtml(price)}</span></div>
            <div style="margin-top:8px" class="muted">Tap "Open UPI app" to attempt direct payment on mobile; or scan QR shown.</div>
            <div style="margin-top:8px" class="trip-actions">
              <button class="ghost copy-upi" type="button">Copy UPI</button>
              <button class="ghost open-upi" type="button">Open UPI app</button>
            </div>
            <div style="margin-top:8px">Or change amount and pay:</div>
            <div style="display:flex; gap:8px; margin-top:6px">
              <input name="amount" type="number" step="1" placeholder="${numeric || ''}" style="flex:1; padding:8px; border-radius:8px; border:1px solid #eee"/>
              <button class="pay-amount" type="button">Pay</button>
            </div>
          </div>
        </div>
      `;
      openModal('Pay & Book ‚Äî ' + title, inner);
    }

    function viewPlace(title){
      // show a simple info modal with thumbnails (match by name) - here we show list of images in gallery
      let body = '<div style="max-height:400px; overflow:auto">';
      const thumbs = document.querySelectorAll('#placesGallery img');
      if(thumbs.length === 0) body += '<div class="muted">No images loaded. Please upload Images.pdf.</div>';
      else{
        body += '<div style="display:flex; gap:8px; flex-wrap:wrap">';
        thumbs.forEach(img => { body += `<img src="${img.src}" style="width:160px;height:100px;object-fit:cover;border-radius:8px;margin:6px">`; });
        body += '</div>';
      }
      body += '</div>';
      openModal(title, body);
    }

    /********* Register form logic (mailto + whatsapp) *********/
    el('paidBtn').addEventListener('click', onPaidClicked);
    function onPaidClicked(){
      el('registerForm').style.display = 'flex';
      el('registerForm').scrollIntoView({behavior:'smooth'});
    }
    // Set wa and sms links
    el('waLink').href = `https://wa.me/${ADMIN_PHONE.replace(/\D/g,'')}?text=${encodeURIComponent(DEFAULT_WA_MESSAGE)}`;
    el('smsLink').href = `sms:${ADMIN_PHONE.replace(/\D/g,'')}&body=${encodeURIComponent(DEFAULT_WA_MESSAGE)}`;
    // form submit
    el('registerForm').addEventListener('submit', function(e){
      e.preventDefault();
      const name = el('name').value.trim();
      const mobile = el('mobile').value.trim();
      const notes = el('notes').value.trim();
      const txn = el('txn').value.trim();
      const trip = el('tripSelect').value;
      const dateIso = el('dateSelect').value;
      const dateReadable = new Date(dateIso).toLocaleDateString(undefined, {weekday:'short', day:'2-digit', month:'short', year:'numeric'});

      if(!name || !/^\d{10}$/.test(mobile)){
        alert('Please enter your name and a valid 10-digit mobile number.');
        return;
      }

      const regObj = { name, mobile, trip, date: dateReadable, txn, notes, submittedAt: new Date().toISOString() };

      // 1) open mail client to send registration to admin (mailto)
      const subject = encodeURIComponent('New Trip Registration ‚Äî ' + trip);
      const body = encodeURIComponent('Registration details:\n' + JSON.stringify(regObj, null, 2));
      const mailto = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
      window.open(mailto, '_blank');

      // 2) open WhatsApp to notify admin
      const waMsg = encodeURIComponent(`New registration:\nName: ${name}\nMobile: ${mobile}\nTrip: ${trip}\nDate: ${dateReadable}\nTxn: ${txn || '‚Äî'}\nNotes: ${notes || '‚Äî'}`);
      const waUrl = `https://wa.me/${ADMIN_PHONE.replace(/\D/g,'')}?text=${waMsg}`;
      window.open(waUrl, '_blank');

      const msgEl = el('formMsg');
      msgEl.textContent = 'Registration submitted. We opened your mail app and WhatsApp to notify the organizer. If nothing opened, please email to ' + ADMIN_EMAIL + ' or message ' + ADMIN_PHONE;
      el('registerForm').reset();
      setTimeout(()=>{ el('registerForm').style.display='none'; }, 2500);
    });

    /********* PDF upload & image extraction (uses pdf.js) *********/
    const pdfUploader = el('pdfUploader');
    const placesGallery = el('placesGallery');
    const pdfUploaderLabel = el('pdfUploaderLabel');
    // allow clicking label to open file input
    pdfUploaderLabel.addEventListener('click', ()=> pdfUploader.click());

    // image compression helper (canvas)
    function compressImage(img, maxW=1200, quality=0.75){
      return new Promise((resolve)=>{
        const canvas = document.createElement('canvas');
        let w = img.naturalWidth, h = img.naturalHeight;
        if(w > maxW){
          const ratio = maxW / w;
          w = Math.round(w * ratio);
          h = Math.round(h * ratio);
        }
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          // create dataURL (base64) - optional, but handy to persist to localStorage
          const reader = new FileReader();
          reader.onload = ()=> resolve(reader.result);
          reader.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      });
    }

    async function handlePdfFile(file){
      // Clear gallery
      placesGallery.innerHTML = `<div class="muted">Processing PDF... this may take a few seconds</div>`;
      const arrayBuffer = await file.arrayBuffer();
      const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
      const pdf = await loadingTask.promise;
      const total = pdf.numPages;
      placesGallery.innerHTML = ''; // clear status
      // limit pages to avoid huge load (but we will process all pages reasonably)
      const pageLimit = Math.min(total, 60);
      for(let i=1;i<=pageLimit;i++){
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({scale:1.5});
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({canvasContext:ctx, viewport}).promise;
        // convert canvas to compressed JPEG dataURL
        const dataUrl = await new Promise(resolve => canvas.toBlob(blob=>{
          const img = new Image();
          img.onload = async ()=>{
            const small = await compressImage(img, 1200, 0.7);
            resolve(small);
            URL.revokeObjectURL(img.src);
          };
          img.src = URL.createObjectURL(blob);
        }, 'image/png'));
        // create thumbnail
        const thumb = document.createElement('img');
        thumb.src = dataUrl;
        thumb.className = 'thumb';
        thumb.alt = 'place-'+i;
        thumb.onclick = ()=> setMainMedia(dataUrl, thumb);
        placesGallery.appendChild(thumb);
        // Save to localStorage progressively (we store array)
        appendToSavedGallery(dataUrl);
        await new Promise(r=>setTimeout(r, 120)); // small yield to keep UI responsive
      }
      // auto-select first thumbnail
      const first = placesGallery.querySelector('img');
      if(first) { first.classList.add('active'); setMainMedia(first.src, first); }
    }

    // Local gallery persistence helpers
    function appendToSavedGallery(dataUrl){
      let arr = JSON.parse(localStorage.getItem('gvr_gallery') || '[]');
      arr.push(dataUrl);
      localStorage.setItem('gvr_gallery', JSON.stringify(arr.slice(-60))); // keep recent 60
    }
    function restoreGallery(){
      const arr = JSON.parse(localStorage.getItem('gvr_gallery') || '[]');
      placesGallery.innerHTML = '';
      arr.forEach((d,i)=>{
        const thumb = document.createElement('img'); thumb.src = d; thumb.className='thumb'; thumb.alt='g-' + i;
        thumb.onclick = ()=> setMainMedia(d, thumb);
        placesGallery.appendChild(thumb);
      });
      const first = placesGallery.querySelector('img');
      if(first) first.click();
    }

    function setMainMedia(dataUrl, thumbEl){
      // toggle active
      document.querySelectorAll('#placesGallery img').forEach(im=>im.classList.remove('active'));
      if(thumbEl) thumbEl.classList.add('active');
      const main = el('mainMedia');
      main.innerHTML = `<img src="${dataUrl}" style="max-width:100%; max-height:100%; object-fit:contain; border-radius:8px">`;
      // keep image accessible as main preview
    }

    pdfUploader.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      try{
        await handlePdfFile(f);
      }catch(err){
        console.error(err);
        alert('Failed to process PDF. Ensure it is a valid PDF with images.');
      }
    });

    // restore gallery on load
    restoreGallery();

    /********* Logo & QR uploader *********/
    const logoUploader = el('logoUploader');
    const qrUploader = el('qrUploader');
    el('logoUploaderLabel').addEventListener('click', ()=> logoUploader.click());
    el('qrUploaderLabel').addEventListener('click', ()=> qrUploader.click());

    logoUploader.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const img = new Image();
      img.onload = async ()=>{
        const compressed = await compressImage(img, 600, 0.8);
        siteLogoEl.src = compressed; localStorage.setItem('gvr_logo', compressed);
      };
      img.src = URL.createObjectURL(f);
    });
    qrUploader.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const img = new Image();
      img.onload = async ()=>{
        const compressed = await compressImage(img, 600, 0.9);
        qrImgEl.src = compressed; qrImgEl.style.display='block';
        localStorage.setItem('gvr_qr', compressed);
      };
      img.src = URL.createObjectURL(f);
    });

    /********* Small utilities: escaping for safety *********/
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeJs(s){
      return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"');
    }

    /********* Small UX: allow clicking thumbnails to view; double-click removes */ 
    placesGallery.addEventListener('dblclick', (e)=>{
      if(e.target.tagName === 'IMG'){
        if(confirm('Remove this thumbnail from gallery?')) {
          const url = e.target.src;
          e.target.remove();
          let arr = JSON.parse(localStorage.getItem('gvr_gallery') || '[]');
          arr = arr.filter(x=>x!==url);
          localStorage.setItem('gvr_gallery', JSON.stringify(arr));
          // if removed main image, set first as main
          const first = placesGallery.querySelector('img');
          if(first) setMainMedia(first.src, first);
        }
      }
    });

    /********* Boot: restore any previously uploaded images (logo/qr/gallery) *********/
    restoreSavedImages();
    restoreGallery();

    /********* Optional: allow user to clear stored images if they want (developer use) *********/
    window.__gvr_clear_storage = function(){ localStorage.removeItem('gvr_gallery'); localStorage.removeItem('gvr_qr'); localStorage.removeItem('gvr_logo'); alert('Cleared local images. Reload page.'); };

    /********* End of script *********/
  </script>
</body>
</html>
